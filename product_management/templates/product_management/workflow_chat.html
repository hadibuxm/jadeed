{% extends 'product_management/base.html' %}

{% block title %}{{ workflow_step.title }} - {{ workflow_step.get_step_type_display }}{% endblock %}

{% block extra_css %}
<style>
    .typing-indicator {
        color: #6c757d;
        font-style: italic;
    }

    .typing-indicator::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }

    /* Smooth scrolling */
    #chatContainer {
        scroll-behavior: smooth;
    }

    /* Message styling */
    .chat-message {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Creative gradient text */
    .text-creative {
        background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 50%, #F59E0B 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'product_management:index' %}">Projects</a></li>
                <li class="breadcrumb-item"><a href="{% url 'product_management:project_detail' project.id %}">{{ project.name }}</a></li>
                <li class="breadcrumb-item active">{{ workflow_step.title }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <!-- Left Column: Step Information & README -->
    <div class="col-lg-3">
        <div class="card mb-3">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Step Information</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <span class="workflow-badge badge-{{ workflow_step.step_type }}">
                        {% if workflow_step.step_type == 'vision' %}<i class="fas fa-eye me-1"></i>
                        {% elif workflow_step.step_type == 'initiative' %}<i class="fas fa-flag me-1"></i>
                        {% elif workflow_step.step_type == 'portfolio' %}<i class="fas fa-folder me-1"></i>
                        {% elif workflow_step.step_type == 'product' %}<i class="fas fa-box me-1"></i>
                        {% elif workflow_step.step_type == 'feature' %}<i class="fas fa-puzzle-piece me-1"></i>
                        {% endif %}
                        {{ workflow_step.get_step_type_display }}
                    </span>
                    {% if workflow_step.is_completed %}
                    <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Completed</span>
                    {% endif %}
                </div>
                <h6 class="mb-3">{{ workflow_step.title }}</h6>
                <p class="small text-muted">{{ workflow_step.description }}</p>
                <hr>
                <div class="small">
                    <div class="mb-2">
                        <strong>Created:</strong><br>
                        {{ workflow_step.created_at|date:"M d, Y H:i" }}
                    </div>
                    <div>
                        <strong>Last Updated:</strong><br>
                        {{ workflow_step.updated_at|date:"M d, Y H:i" }}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3" id="readmeCard" style="display: none;">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>README</h6>
            </div>
            <div class="card-body">
                <div id="readmePreview" class="small" style="max-height: 300px; overflow-y: auto;"></div>
                {% if workflow_step.step_type == 'feature' %}
                <div class="alert alert-info mt-3 mb-0">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Note:</strong> This README will be used for AI code generation when implementing the feature.
                    </small>
                </div>
                {% endif %}
                {% if project.github_repository %}
                <button class="btn btn-sm btn-creative-outline w-100 mt-3" id="saveToGithubBtn">
                    <i class="fab fa-github me-1"></i>Save to GitHub
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Middle Column: Chat Interface -->
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-comments me-2"></i>AI Conversation</h6>
            </div>
            <div class="card-body" style="height: 500px; overflow-y: auto;" id="chatContainer">
                <div id="chatMessages">
                    <div class="alert alert-info">
                        <i class="fas fa-robot me-2"></i>
                        <strong>AI Assistant Ready!</strong>
                        <p class="mb-0 mt-2">I'll help you define your {{ workflow_step.get_step_type_display|lower }}. Start by sharing your thoughts, and I'll guide you through the process with questions and suggestions.</p>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white">
                <form id="chatForm" class="d-flex gap-2">
                    <input type="text" class="form-control" id="messageInput" placeholder="Type your message..." autocomplete="off">
                    <button type="submit" class="btn btn-creative" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Column: Actions -->
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-tools me-2"></i>Actions</h6>
            </div>
            <div class="card-body">
                <button class="btn btn-creative-outline w-100 mb-2" id="generateReadmeBtn">
                    <i class="fas fa-file-alt me-1"></i>Generate README
                </button>

                {% if workflow_step.step_type == 'feature' and project.github_repository %}
                <div class="mb-3">
                    <div class="alert alert-light border mb-2">
                        <small class="text-muted">
                            <i class="fas fa-magic text-creative me-1"></i>
                            <strong>AI Code Generation:</strong> Automatically implement this feature using AI
                        </small>
                        <hr class="my-2">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>Tip:</strong> Generate a README first for best results
                        </small>
                    </div>
                    <button class="btn btn-creative w-100 mb-2" id="requestCodeChangeBtn">
                        <i class="fas fa-code me-1"></i>Implement Feature with AI
                    </button>
                    <div id="codeChangeStatus" class="mt-2" style="display: none;">
                        <div class="alert alert-info mb-0" id="statusMessage">
                            <small id="statusText"></small>
                        </div>
                    </div>
                </div>
                {% elif workflow_step.step_type == 'feature' %}
                <div class="alert alert-warning mb-2">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        Connect a GitHub repository to enable AI code generation
                    </small>
                </div>
                {% endif %}

                {% if not workflow_step.is_completed %}
                <button class="btn btn-success w-100" id="completeStepBtn">
                    <i class="fas fa-check me-1"></i>Mark as Completed
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const stepId = {{ workflow_step.id }};
const chatMessages = document.getElementById('chatMessages');
const chatContainer = document.getElementById('chatContainer');
const messageInput = document.getElementById('messageInput');
const chatForm = document.getElementById('chatForm');
const sendBtn = document.getElementById('sendBtn');

// Load conversation history
loadConversation();

// Send message with streaming
chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message to chat
    addMessageToChat('user', message);
    messageInput.value = '';
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    // Create placeholder for assistant message
    const assistantMessageDiv = document.createElement('div');
    assistantMessageDiv.className = 'mb-3';
    const bubble = document.createElement('div');
    bubble.className = 'd-inline-block p-3 rounded bg-light';
    bubble.style.maxWidth = '80%';
    bubble.style.textAlign = 'left';
    bubble.innerHTML = '<span class="typing-indicator">AI is thinking...</span>';
    assistantMessageDiv.appendChild(bubble);
    chatMessages.appendChild(assistantMessageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    let fullMessage = '';
    let isFirstChunk = true;

    // Send to server with streaming
    fetch(`/product-management/workflow/${stepId}/message/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ message: message, stream: true })
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        function readStream() {
            reader.read().then(({done, value}) => {
                if (done) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    return;
                }

                const chunk = decoder.decode(value, {stream: true});
                const lines = chunk.split('\n');

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));

                            if (data.error) {
                                bubble.innerHTML = `<span class="text-danger">Error: ${data.error}</span>`;
                                sendBtn.disabled = false;
                                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                                return;
                            }

                            if (data.content) {
                                if (isFirstChunk) {
                                    bubble.innerHTML = '';
                                    isFirstChunk = false;
                                }
                                fullMessage += data.content;
                                bubble.innerHTML = marked.parse(fullMessage);
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }

                            if (data.done) {
                                sendBtn.disabled = false;
                                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                            }
                        } catch (e) {
                            // Ignore parsing errors for incomplete chunks
                        }
                    }
                });

                readStream();
            });
        }

        readStream();
    })
    .catch(error => {
        bubble.innerHTML = `<span class="text-danger">Error: ${error}</span>`;
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
    });
});

// Generate README
document.getElementById('generateReadmeBtn').addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';

    fetch(`/product-management/workflow/${stepId}/readme/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('readmePreview').innerHTML = marked.parse(data.readme_content);
            document.getElementById('readmeCard').style.display = 'block';
            alert('README generated successfully!');
        } else {
            alert('Error: ' + data.error);
        }
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-file-alt me-1"></i>Generate README';
    })
    .catch(error => {
        alert('Error generating README: ' + error);
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-file-alt me-1"></i>Generate README';
    });
});

// Complete step
{% if not workflow_step.is_completed %}
document.getElementById('completeStepBtn').addEventListener('click', function() {
    if (!confirm('Mark this step as completed?')) return;

    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Completing...';

    fetch(`/product-management/workflow/${stepId}/complete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Step marked as completed!');
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check me-1"></i>Mark as Completed';
        }
    })
    .catch(error => {
        alert('Error completing step: ' + error);
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-check me-1"></i>Mark as Completed';
    });
});
{% endif %}

// Request Code Change (Feature Implementation)
{% if workflow_step.step_type == 'feature' and project.github_repository %}
const workflowData = {
    title: '{{ workflow_step.title|escapejs }}',
    description: '{{ workflow_step.description|escapejs }}',
    conversationHistory: {{ conversation_json|safe }}
};

document.getElementById('requestCodeChangeBtn')?.addEventListener('click', function() {
    // Check if README is available (better context than raw conversation)
    const readmeContent = document.getElementById('readmePreview')?.textContent;

    let changeRequest = `Feature: ${workflowData.title}\n\n`;
    changeRequest += `Description: ${workflowData.description}\n\n`;

    // Prefer README if available, otherwise use conversation history
    if (readmeContent && readmeContent.trim().length > 0) {
        changeRequest += 'Feature Specification (from generated README):\n\n';
        changeRequest += readmeContent;
        changeRequest += '\n\nPlease implement this feature based on the specification above.';
    } else if (workflowData.conversationHistory && workflowData.conversationHistory.length > 0) {
        changeRequest += 'Context from AI conversation:\n';
        workflowData.conversationHistory.forEach(msg => {
            if (msg.role === 'user' || msg.role === 'assistant') {
                changeRequest += `${msg.role}: ${msg.content.substring(0, 500)}\n`;
            }
        });
        changeRequest += '\n\nNote: Consider generating a README first for better results.';
    } else {
        alert('Please have a conversation with AI or generate a README before requesting code implementation.');
        return;
    }

    const message = readmeContent && readmeContent.trim().length > 0
        ? 'This will implement the feature based on the generated README. Continue?'
        : 'No README found. This will use the raw conversation. For better results, generate a README first. Continue anyway?';

    if (!confirm(message)) {
        return;
    }

    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Requesting...';

    fetch('/github/request-code-change/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            repo_id: {{ project.github_repository.id }},
            change_request: changeRequest
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Code change request submitted successfully!');
            document.getElementById('codeChangeStatus').style.display = 'block';
            document.getElementById('statusText').textContent = 'Processing code changes...';

            // Start polling for status
            pollCodeChangeStatus(data.request_id);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-code me-1"></i>Implement Feature';
    })
    .catch(error => {
        alert('Error requesting code change: ' + error);
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-code me-1"></i>Implement Feature';
    });
});

function pollCodeChangeStatus(requestId) {
    const statusInterval = setInterval(() => {
        fetch(`/github/code-change-status/${requestId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const status = data.status;
                const statusElement = document.getElementById('statusText');

                statusElement.textContent = `Status: ${status}`;

                if (data.execution_log) {
                    const lastLine = data.execution_log.trim().split('\n').pop();
                    statusElement.textContent += ` - ${lastLine}`;
                }

                // Stop polling if completed or failed
                if (status === 'completed') {
                    clearInterval(statusInterval);
                    document.getElementById('statusMessage').className = 'alert alert-success mb-0';
                    statusElement.textContent = 'Code changes completed successfully!';
                    if (data.branch_name) {
                        statusElement.textContent += ` Branch: ${data.branch_name}`;
                    }
                } else if (status === 'failed') {
                    clearInterval(statusInterval);
                    document.getElementById('statusMessage').className = 'alert alert-danger mb-0';
                    statusElement.textContent = 'Code changes failed: ' + (data.error_message || 'Unknown error');
                }
            }
        })
        .catch(error => {
            console.error('Error polling status:', error);
        });
    }, 3000); // Poll every 3 seconds
}
{% endif %}

// Save to GitHub
{% if project.github_repository %}
document.getElementById('saveToGithubBtn')?.addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

    fetch(`/product-management/workflow/${stepId}/readme/?save_to_github=true`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const message = data.message || 'README saved to GitHub!';
            alert(message);
            if (data.github_url) {
                window.open(data.github_url, '_blank');
            }
            if (data.github_file_path) {
                console.log('README saved to:', data.github_file_path);
            }
            if (data.github_error) {
                alert('Warning: ' + data.github_error);
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
        this.disabled = false;
        this.innerHTML = '<i class="fab fa-github me-1"></i>Save to GitHub';
    })
    .catch(error => {
        alert('Error saving to GitHub: ' + error);
        this.disabled = false;
        this.innerHTML = '<i class="fab fa-github me-1"></i>Save to GitHub';
    });
});
{% endif %}

function loadConversation() {
    fetch(`/product-management/workflow/${stepId}/conversation/`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.conversation && data.conversation.length > 0) {
            // Clear welcome message
            chatMessages.innerHTML = '';
            data.conversation.forEach(msg => {
                addMessageToChat(msg.role, msg.content, false);
            });
        }
        if (data.readme_content) {
            document.getElementById('readmePreview').innerHTML = marked.parse(data.readme_content);
            document.getElementById('readmeCard').style.display = 'block';
        }
    });
}

function addMessageToChat(role, content, scroll = true) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 ${role === 'user' ? 'text-end' : ''}`;

    const bubble = document.createElement('div');
    bubble.className = `d-inline-block p-3 rounded ${role === 'user' ? 'bg-primary text-white' : 'bg-light'}`;
    bubble.style.maxWidth = '80%';
    bubble.style.textAlign = 'left';

    if (role === 'assistant') {
        bubble.innerHTML = marked.parse(content);
    } else {
        bubble.textContent = content;
    }

    messageDiv.appendChild(bubble);
    chatMessages.appendChild(messageDiv);

    if (scroll) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}
