{% extends 'product_management/base.html' %}

{% block title %}{{ workflow_step.title }}{% endblock %}

{% block extra_css %}
<style>
    .typing-indicator {
        color: #6c757d;
        font-style: italic;
    }

    .typing-indicator::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }

    /* Smooth scrolling */
    #chatContainer {
        scroll-behavior: smooth;
    }

    /* Message styling */
    .chat-message {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Creative gradient text */
    .text-creative {
        background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 50%, #F59E0B 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'product_management:hierarchy' %}">Roadmap</a></li>
                {% if project %}
                <li class="breadcrumb-item"><a href="{% url 'product_management:project_detail' project.id %}">{{ project.name }}</a></li>
                {% endif %}
                {% for item in hierarchy %}
                    {% if forloop.last %}
                        <li class="breadcrumb-item active" aria-current="page">
                            <span class="badge badge-{{ item.step_type }} me-1">{{ item.get_step_type_display }}</span>
                            {{ item.title }}
                        </li>
                    {% else %}
                        <li class="breadcrumb-item">
                            <span class="badge badge-{{ item.step_type }} me-1">{{ item.get_step_type_display }}</span>
                            {% if item.step_type == 'product' %}
                                <a href="{% url 'product_management:product_steps' item.id %}">{{ item.title }}</a>
                            {% elif item.step_type == 'feature' %}
                                <a href="{% url 'product_management:feature_steps' item.id %}">{{ item.title }}</a>
                            {% else %}
                                <a href="{% url 'product_management:workflow_chat' item.id %}">{{ item.title }}</a>
                            {% endif %}
                        </li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start">
            
            <div>
                <button class="btn btn-danger btn-sm delete-workflow-step-btn"
                        data-step-id="{{ workflow_step.id }}"
                        data-step-title="{{ workflow_step.title }}"
                        data-step-type="{{ workflow_step.get_step_type_display }}">
                    <i class="fas fa-trash me-1"></i>Delete {{ workflow_step.get_step_type_display }}
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column: Step Information & README -->
    <div class="col-lg-3">
        <div class="card mb-3">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Step Information</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <span class="workflow-badge badge-{{ workflow_step.step_type }}">
                        {% if workflow_step.step_type == 'vision' %}<i class="fas fa-eye me-1"></i>
                        {% elif workflow_step.step_type == 'initiative' %}<i class="fas fa-flag me-1"></i>
                        {% elif workflow_step.step_type == 'portfolio' %}<i class="fas fa-folder me-1"></i>
                        {% elif workflow_step.step_type == 'product' %}<i class="fas fa-box me-1"></i>
                        {% elif workflow_step.step_type == 'feature' %}<i class="fas fa-puzzle-piece me-1"></i>
                        {% endif %}
                        {{ workflow_step.get_step_type_display }}
                    </span>
                    {% if workflow_step.is_completed %}
                    <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Completed</span>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">{{ workflow_step.title }}</h6>
                    <button type="button"
                            class="btn btn-sm btn-creative-outline"
                            id="editDescriptionBtn">
                        <i class="fas fa-pen me-1"></i>Edit Description
                    </button>
                </div>
                <div class="small text-muted text-uppercase fw-semibold mb-2">
                    Overview
                </div>
                <div id="workflowDescriptionDisplay">
                    {% if workflow_step.description %}
                    <div class="small text-muted" id="workflowDescriptionText">
                        {{ workflow_step.description|linebreaksbr }}
                    </div>
                    {% else %}
                    <div class="small text-muted fst-italic" id="workflowDescriptionText">
                        No description yet. Use "Edit Description" to add more context.
                    </div>
                    {% endif %}
                </div>
                <div id="workflowDescriptionForm" class="mt-3" style="display: none;">
                    <textarea class="form-control"
                              id="workflowDescriptionInput"
                              rows="4"
                              placeholder="Add details for this {{ workflow_step.get_step_type_display|lower }}...">{{ workflow_step.description|default_if_none:'' }}</textarea>
                    <div class="d-flex justify-content-end gap-2 mt-2">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                id="cancelDescriptionBtn">
                            Cancel
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-creative"
                                id="saveDescriptionBtn">
                            <i class="fas fa-save me-1"></i>Save Description
                        </button>
                    </div>
                </div>
                <hr>
                <div class="small">
                    <div class="mb-2">
                        <strong>Created:</strong><br>
                        {{ workflow_step.created_at|date:"M d, Y H:i" }}
                    </div>
                    <div>
                        <strong>Last Updated:</strong><br>
                        {{ workflow_step.updated_at|date:"M d, Y H:i" }}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3" id="readmeCard" style="display: none;">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>README</h6>
            </div>
            <div class="card-body">
                <div id="readmePreview" class="small" style="max-height: 300px; overflow-y: auto;"></div>
                {% if workflow_step.step_type == 'feature' %}
                <div class="alert alert-info mt-3 mb-0">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Note:</strong> This README will be used for AI code generation when implementing the feature.
                    </small>
                </div>
                {% endif %}
                {% if project.github_repository %}
                <button class="btn btn-sm btn-creative-outline w-100 mt-3" id="saveToGithubBtn">
                    <i class="fab fa-github me-1"></i>Save to GitHub
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Middle Column: Chat Interface -->
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-comments me-2"></i>AI Conversation</h6>
            </div>
            <div class="card-body" style="height: 500px; overflow-y: auto;" id="chatContainer">
                <div id="chatMessages">
                    <div class="alert alert-info">
                        <i class="fas fa-robot me-2"></i>
                        <strong>AI Assistant Ready!</strong>
                        <p class="mb-0 mt-2">I'll help you define your {{ workflow_step.get_step_type_display|lower }}. Start by sharing your thoughts, and I'll guide you through the process with questions and suggestions.</p>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white">
                <form id="chatForm" class="d-flex gap-2">
                    <input type="text" class="form-control" id="messageInput" placeholder="Type your message..." autocomplete="off">
                    <button type="submit" class="btn btn-creative" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Comments</h6>
                    <span class="badge bg-light text-muted" id="commentCountBadge">{{ comment_count }}</span>
                </div>
            </div>
            <div class="card-body">
                <div id="commentEmptyState"
                     class="text-muted small fst-italic"
                     {% if comment_count %}style="display:none;"{% endif %}>
                    No comments yet. Share the first thought about this {{ workflow_step.get_step_type_display|lower }}.
                </div>
                <ul class="list-group list-group-flush" id="commentList"></ul>
            </div>
            <div class="card-footer bg-white">
                <form id="commentForm">
                    <div class="input-group">
                        <textarea class="form-control"
                                  id="commentInput"
                                  rows="2"
                                  maxlength="2000"
                                  placeholder="Add a comment..."></textarea>
                        <button type="submit"
                                class="btn btn-creative"
                                id="commentSubmitBtn">
                            <i class="fas fa-paper-plane me-1"></i>Post
                        </button>
                    </div>
                </form>
            </div>
        </div>

        

        <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Generated Documents</h6>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-light text-muted" id="documentCountBadge">{{ document_count }}</span>
                    <button class="btn btn-sm btn-outline-secondary" id="refreshDocumentsBtn" title="Refresh documents">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-5 mb-3 mb-lg-0">
                        <div class="list-group small" id="documentList" role="tablist"></div>
                        <div id="documentEmptyState"
                             class="text-muted small fst-italic mt-2"
                             {% if document_count %}style="display:none;"{% endif %}>
                            No documents generated yet. Create a README to populate this list.
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="border rounded p-3 h-100">
                            <div id="documentPreviewEmpty"
                                 class="text-muted small fst-italic"
                                 {% if document_count %}style="display:none;"{% endif %}>
                                Select a document to preview it here.
                            </div>
                            <div id="documentPreview" class="small" style="max-height: 350px; overflow-y: auto; display: none;"></div>
                            <div id="documentMeta" class="text-muted small mt-2" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Actions -->
    <div class="col-lg-3">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="fas fa-tools me-2"></i>Actions</h6>
            </div>
            <div class="card-body">
                <button class="btn btn-creative-outline w-100 mb-2" id="generateReadmeBtn">
                    <i class="fas fa-file-alt me-1"></i>Generate README
                </button>

                {% if workflow_step.step_type == 'feature' and project.github_repository %}
                <div class="mb-3">
                    <div class="alert alert-light border mb-2">
                        <small class="text-muted">
                            <i class="fas fa-magic text-creative me-1"></i>
                            <strong>AI Code Generation:</strong> Automatically implement this feature using AI
                        </small>
                        <hr class="my-2">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>Tip:</strong> Generate a README first for best results
                        </small>
                    </div>
                    <button class="btn btn-creative w-100 mb-2" id="requestCodeChangeBtn">
                        <i class="fas fa-code me-1"></i>Implement Feature with AI
                    </button>
                    <div id="codeChangeStatus" class="mt-2" style="display: none;">
                        <div class="alert alert-info mb-2" id="statusMessage">
                            <small id="statusText"></small>
                        </div>
                        <div class="card border-secondary" id="codeChangeLogCard" style="display: none;">
                            <div class="card-body py-2">
                                <small class="text-muted d-block mb-1 fw-semibold">
                                    Execution Log
                                </small>
                                <pre class="small mb-0" id="codeChangeLogContent" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
                {% elif workflow_step.step_type == 'feature' %}
                <div class="alert alert-warning mb-2">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        Connect a GitHub repository to enable AI code generation
                    </small>
                </div>
                {% endif %}

                {% if not workflow_step.is_completed %}
                <button class="btn btn-success w-100" id="completeStepBtn">
                    <i class="fas fa-check me-1"></i>Mark as Completed
                </button>
                {% endif %}
            </div>
        </div>
        <br>
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-history me-2"></i>Action History</h6>
                <button class="btn btn-sm btn-outline-secondary" id="refreshActionsBtn">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="actionHistoryEmpty"
                     class="text-muted small fst-italic"
                     style="display: none;">
                    No actions recorded yet.
                </div>
                <ul class="list-group list-group-flush" id="actionHistoryList"></ul>
            </div>
        </div>
    </div>
</div>

<!-- AI processing modal -->
<div class="modal fade" id="aiProcessingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center border-0 shadow">
            <div class="modal-body py-5">
                <div class="spinner-border text-creative mb-3" role="status" aria-hidden="true"></div>
                <p class="fw-semibold mb-0">Working on it….</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const stepId = {{ workflow_step.id }};
const chatMessages = document.getElementById('chatMessages');
const chatContainer = document.getElementById('chatContainer');
const messageInput = document.getElementById('messageInput');
const chatForm = document.getElementById('chatForm');
const sendBtn = document.getElementById('sendBtn');
const readmeCard = document.getElementById('readmeCard');
const readmePreview = document.getElementById('readmePreview');
const editDescriptionBtn = document.getElementById('editDescriptionBtn');
const descriptionDisplay = document.getElementById('workflowDescriptionDisplay');
const descriptionForm = document.getElementById('workflowDescriptionForm');
const descriptionInput = document.getElementById('workflowDescriptionInput');
const descriptionText = document.getElementById('workflowDescriptionText');
const cancelDescriptionBtn = document.getElementById('cancelDescriptionBtn');
const saveDescriptionBtn = document.getElementById('saveDescriptionBtn');
const emptyDescriptionCopy = 'No description yet. Use "Edit Description" to add more context.';
let descriptionCache = descriptionInput ? descriptionInput.value : '';
const aiProcessingModalElement = document.getElementById('aiProcessingModal');
const aiProcessingModal = aiProcessingModalElement ? new bootstrap.Modal(aiProcessingModalElement) : null;
const codeChangeLogCard = document.getElementById('codeChangeLogCard');
const codeChangeLogContent = document.getElementById('codeChangeLogContent');
const commentList = document.getElementById('commentList');
const commentEmptyState = document.getElementById('commentEmptyState');
const commentCountBadge = document.getElementById('commentCountBadge');
const commentForm = document.getElementById('commentForm');
const commentInput = document.getElementById('commentInput');
const commentSubmitBtn = document.getElementById('commentSubmitBtn');
const initialComments = {{ comments_json|default:'[]'|safe }};
const actionHistoryList = document.getElementById('actionHistoryList');
const actionHistoryEmpty = document.getElementById('actionHistoryEmpty');
const refreshActionsBtn = document.getElementById('refreshActionsBtn');
const documentList = document.getElementById('documentList');
const documentEmptyState = document.getElementById('documentEmptyState');
const documentPreview = document.getElementById('documentPreview');
const documentPreviewEmpty = document.getElementById('documentPreviewEmpty');
const documentMeta = document.getElementById('documentMeta');
const documentCountBadge = document.getElementById('documentCountBadge');
const refreshDocumentsBtn = document.getElementById('refreshDocumentsBtn');
const initialActions = {{ actions_json|default:'[]'|safe }};
const initialDocuments = {{ documents_json|default:'[]'|safe }};
let actionHistory = Array.isArray(initialActions) ? initialActions : [];
let documentHistory = Array.isArray(initialDocuments) ? initialDocuments : [];
let activeDocumentId = documentHistory.length ? documentHistory[0].id : null;

function showAiProcessingModal() {
    aiProcessingModal?.show();
}

function hideAiProcessingModal() {
    aiProcessingModal?.hide();
}

function combineExecutionAndCodexLogs(executionLog, codexLogs) {
    const sections = [];
    if (executionLog && executionLog.trim()) {
        sections.push(executionLog.trim());
    }
    if (codexLogs && codexLogs.trim()) {
        sections.push('=== Codex CLI Output ===\n' + codexLogs.trim());
    }
    return sections.join('\n\n');
}

if (Array.isArray(initialComments) && initialComments.length) {
    initialComments.forEach(comment => addCommentToList(comment));
}
updateCommentEmptyState();
renderActionHistory();
renderDocumentList(activeDocumentId);
updateDocumentCount(documentHistory.length);

// Load conversation history
loadConversation();

// Send message with streaming
chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message to chat
    addMessageToChat('user', message);
    messageInput.value = '';
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    // Create placeholder for assistant message
    const assistantMessageDiv = document.createElement('div');
    assistantMessageDiv.className = 'mb-3';
    const bubble = document.createElement('div');
    bubble.className = 'd-inline-block p-3 rounded bg-light';
    bubble.style.maxWidth = '80%';
    bubble.style.textAlign = 'left';
    bubble.innerHTML = '<span class="typing-indicator">AI is thinking...</span>';
    assistantMessageDiv.appendChild(bubble);
    chatMessages.appendChild(assistantMessageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    let fullMessage = '';
    let isFirstChunk = true;

    // Send to server with streaming
    fetch(`/product-management/workflow/${stepId}/message/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ message: message, stream: true })
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        function readStream() {
            reader.read().then(({done, value}) => {
                if (done) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    return;
                }

                const chunk = decoder.decode(value, {stream: true});
                const lines = chunk.split('\n');

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));

                            if (data.error) {
                                bubble.innerHTML = `<span class="text-danger">Error: ${data.error}</span>`;
                                sendBtn.disabled = false;
                                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                                return;
                            }

                            if (data.content) {
                                if (isFirstChunk) {
                                    bubble.innerHTML = '';
                                    isFirstChunk = false;
                                }
                                fullMessage += data.content;
                                bubble.innerHTML = marked.parse(fullMessage);
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }

                            if (data.done) {
                                sendBtn.disabled = false;
                                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                            }
                        } catch (e) {
                            // Ignore parsing errors for incomplete chunks
                        }
                    }
                });

                readStream();
            });
        }

        readStream();
    })
    .catch(error => {
        bubble.innerHTML = `<span class="text-danger">Error: ${error}</span>`;
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
    });
});

commentForm?.addEventListener('submit', function(e) {
    e.preventDefault();
    if (!commentInput || !commentSubmitBtn) {
        return;
    }
    const content = commentInput.value.trim();
    if (!content) {
        commentInput.focus();
        return;
    }

    const originalLabel = commentSubmitBtn.innerHTML;
    commentSubmitBtn.disabled = true;
    commentSubmitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Posting...';

    fetch(`/product-management/workflow/${stepId}/comments/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.comment) {
            addCommentToList(data.comment, true);
            commentInput.value = '';
            commentInput.focus();
            if (typeof data.count === 'number') {
                updateCommentCount(data.count);
            }
            refreshActionHistory();
        } else {
            alert(data.error || 'Unable to add comment.');
        }
    })
    .catch(error => {
        alert('Error adding comment: ' + error);
    })
    .finally(() => {
        commentSubmitBtn.disabled = false;
        commentSubmitBtn.innerHTML = originalLabel;
    });
});

// Generate README
document.getElementById('generateReadmeBtn').addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';

    fetch(`/product-management/workflow/${stepId}/readme/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateReadmePreview(data.readme_content);
            alert('README generated successfully!');
            if (data.document) {
                handleDocumentUpdate(data.document);
            }
            refreshActionHistory();
        } else {
            alert('Error: ' + data.error);
        }
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-file-alt me-1"></i>Generate README';
    })
    .catch(error => {
        alert('Error generating README: ' + error);
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-file-alt me-1"></i>Generate README';
    });
});

// Complete step
{% if not workflow_step.is_completed %}
document.getElementById('completeStepBtn').addEventListener('click', function() {
    if (!confirm('Mark this step as completed?')) return;

    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Completing...';

    fetch(`/product-management/workflow/${stepId}/complete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Step marked as completed!');
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check me-1"></i>Mark as Completed';
        }
    })
    .catch(error => {
        alert('Error completing step: ' + error);
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-check me-1"></i>Mark as Completed';
    });
});
{% endif %}

// Request Code Change (Feature Implementation)
{% if workflow_step.step_type == 'feature' and project.github_repository %}
const workflowData = {
    title: '{{ workflow_step.title|escapejs }}',
    description: '{{ workflow_step.description|escapejs }}',
    conversationHistory: {{ conversation_json|safe }}
};

document.getElementById('requestCodeChangeBtn')?.addEventListener('click', function() {
    const button = this;
    const originalLabel = button.innerHTML;
    const restoreButton = () => {
        button.disabled = false;
        button.innerHTML = originalLabel;
    };

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Preparing README...';
    showAiProcessingModal();

    ensureReadmeSynced()
        .then(data => {
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Requesting...';
            const changeRequest = buildCodeChangeRequest(data.readme_content);
            return submitCodeChangeRequest(changeRequest);
        })
        .then(() => {
            restoreButton();
        })
        .catch(error => {
            if (error && error.message) {
                alert(error.message);
            } else if (error) {
                alert(error);
            }
            restoreButton();
        })
        .finally(() => {
            hideAiProcessingModal();
        });
});

function ensureReadmeSynced() {
    return fetch(`/product-management/workflow/${stepId}/ensure-readme/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'Failed to sync README.');
        }
        if (data.readme_content) {
            updateReadmePreview(data.readme_content);
        }
        if (data.document) {
            handleDocumentUpdate(data.document);
            refreshActionHistory();
        }
        return data;
    });
}

function buildCodeChangeRequest(readmeContent) {
    const safeDescription = workflowData.description?.trim()?.length
        ? workflowData.description
        : 'No description provided.';

    let changeRequest = `Feature: ${workflowData.title}\n\n`;
    changeRequest += `Description: ${safeDescription}\n\n`;
    changeRequest += 'Feature Specification (from generated README):\n\n';
    changeRequest += `${readmeContent}\n\n`;
    changeRequest += 'Please implement this feature based on the specification above.';

    if (workflowData.conversationHistory && workflowData.conversationHistory.length > 0) {
        changeRequest += '\n\nAdditional context from AI conversation:\n';
        workflowData.conversationHistory.forEach(msg => {
            if (msg.role === 'user' || msg.role === 'assistant') {
                const snippet = msg.content ? msg.content.substring(0, 500) : '';
                changeRequest += `${msg.role}: ${snippet}\n`;
            }
        });
    }

    return changeRequest;
}

function submitCodeChangeRequest(changeRequest) {
    return fetch('/github/request-code-change/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            repo_id: {{ project.github_repository.id }},
            change_request: changeRequest
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'Failed to submit code change request.');
        }
        alert('Code change request submitted successfully!');
        const statusContainer = document.getElementById('codeChangeStatus');
        const statusText = document.getElementById('statusText');
        if (statusContainer && statusText) {
            statusContainer.style.display = 'block';
            statusText.textContent = 'Processing code changes...';
        }
        if (codeChangeLogCard && codeChangeLogContent) {
            codeChangeLogCard.style.display = 'none';
            codeChangeLogContent.textContent = '';
        }
        pollCodeChangeStatus(data.request_id);
    });
}

function pollCodeChangeStatus(requestId) {
    const statusInterval = setInterval(() => {
        fetch(`/github/code-change-status/${requestId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const status = data.status;
                const statusElement = document.getElementById('statusText');

                if (statusElement) {
                    statusElement.textContent = `Status: ${status}`;
                }

                const combinedLogs = combineExecutionAndCodexLogs(
                    data.execution_log,
                    data.codex_logs
                );

                if (combinedLogs) {
                    if (statusElement) {
                        const lastLine = combinedLogs.trim().split('\n').pop();
                        statusElement.textContent += ` - ${lastLine}`;
                    }
                    if (codeChangeLogContent && codeChangeLogCard) {
                        codeChangeLogContent.textContent = combinedLogs;
                        codeChangeLogCard.style.display = 'block';
                        codeChangeLogContent.scrollTop = codeChangeLogContent.scrollHeight;
                    }
                }

                // Stop polling if completed or failed
                if (status === 'completed') {
                    clearInterval(statusInterval);
                    document.getElementById('statusMessage').className = 'alert alert-success mb-0';
                    if (statusElement) {
                        statusElement.textContent = 'Code changes completed successfully!';
                        if (data.branch_name) {
                            statusElement.textContent += ` Branch: ${data.branch_name}`;
                        }
                    }
                } else if (status === 'failed') {
                    clearInterval(statusInterval);
                    document.getElementById('statusMessage').className = 'alert alert-danger mb-0';
                    if (statusElement) {
                        statusElement.textContent = 'Code changes failed: ' + (data.error_message || 'Unknown error');
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error polling status:', error);
        });
    }, 3000); // Poll every 3 seconds
}
{% endif %}

// Save to GitHub
{% if project.github_repository %}
document.getElementById('saveToGithubBtn')?.addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

    fetch(`/product-management/workflow/${stepId}/readme/?save_to_github=true`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const message = data.message || 'README saved to GitHub!';
            alert(message);
            if (data.github_url) {
                window.open(data.github_url, '_blank');
            }
            if (data.github_file_path) {
                console.log('README saved to:', data.github_file_path);
            }
            if (data.github_error) {
                alert('Warning: ' + data.github_error);
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
        this.disabled = false;
        this.innerHTML = '<i class="fab fa-github me-1"></i>Save to GitHub';
    })
    .catch(error => {
        alert('Error saving to GitHub: ' + error);
        this.disabled = false;
        this.innerHTML = '<i class="fab fa-github me-1"></i>Save to GitHub';
    });
});
{% endif %}

function loadConversation() {
    fetch(`/product-management/workflow/${stepId}/conversation/`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.conversation && data.conversation.length > 0) {
            // Clear welcome message
            chatMessages.innerHTML = '';
            data.conversation.forEach(msg => {
                addMessageToChat(msg.role, msg.content, false);
            });
        }
        if (data.readme_content) {
            updateReadmePreview(data.readme_content);
        }
    });
}

function addMessageToChat(role, content, scroll = true) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 ${role === 'user' ? 'text-end' : ''}`;

    const bubble = document.createElement('div');
    bubble.className = `d-inline-block p-3 rounded ${role === 'user' ? 'bg-primary text-white' : 'bg-light'}`;
    bubble.style.maxWidth = '80%';
    bubble.style.textAlign = 'left';

    if (role === 'assistant') {
        bubble.innerHTML = marked.parse(content);
    } else {
        bubble.textContent = content;
    }

    messageDiv.appendChild(bubble);
    chatMessages.appendChild(messageDiv);

    if (scroll) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

function toggleDescriptionEditor(show) {
    if (!descriptionForm || !descriptionDisplay || !editDescriptionBtn) return;
    if (show) {
        descriptionForm.style.display = 'block';
        descriptionDisplay.style.display = 'none';
        editDescriptionBtn.classList.add('d-none');
        descriptionInput?.focus();
        descriptionInput?.setSelectionRange(descriptionInput.value.length, descriptionInput.value.length);
    } else {
        descriptionForm.style.display = 'none';
        descriptionDisplay.style.display = 'block';
        editDescriptionBtn.classList.remove('d-none');
    }
}

function escapeHtml(value) {
    return (value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function renderDescriptionText(text) {
    if (!descriptionText) {
        return;
    }

    if (text && text.trim().length) {
        const escaped = escapeHtml(text).replace(/\n/g, '<br>');
        descriptionText.classList.remove('fst-italic');
        descriptionText.innerHTML = escaped;
    } else {
        descriptionText.classList.add('fst-italic');
        descriptionText.textContent = emptyDescriptionCopy;
    }
}

function updateReadmePreview(content) {
    if (!readmePreview) {
        return;
    }

    readmePreview.innerHTML = marked.parse(content);
    if (readmeCard) {
        readmeCard.style.display = 'block';
    }
}

function updateCommentEmptyState() {
    if (!commentEmptyState || !commentList) {
        return;
    }
    commentEmptyState.style.display = commentList.children.length ? 'none' : 'block';
}

function updateCommentCount(count) {
    if (!commentCountBadge) {
        return;
    }
    commentCountBadge.textContent = count;
}

function formatCommentBody(text) {
    const safe = escapeHtml(text || '');
    return safe.replace(/\n/g, '<br>');
}

function addCommentToList(comment, prepend = false) {
    if (!commentList || !comment) {
        return;
    }
    const item = document.createElement('li');
    item.className = 'list-group-item px-0';
    const author = escapeHtml(comment.user || 'User');
    const timestamp = escapeHtml(comment.created_at || '');
    const content = formatCommentBody(comment.content || '');

    item.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="fw-semibold">${author}</div>
            <div class="text-muted small ms-2">${timestamp}</div>
        </div>
        <div class="small mt-2">${content}</div>
    `;

    if (prepend && commentList.firstChild) {
        commentList.prepend(item);
    } else if (prepend) {
        commentList.appendChild(item);
    } else {
        commentList.appendChild(item);
    }

    updateCommentEmptyState();
}

function renderActionHistory() {
    if (!actionHistoryList || !actionHistoryEmpty) {
        return;
    }
    actionHistoryList.innerHTML = '';
    if (!Array.isArray(actionHistory) || actionHistory.length === 0) {
        actionHistoryEmpty.style.display = 'block';
        return;
    }
    actionHistoryEmpty.style.display = 'none';
    actionHistory.forEach(action => {
        const item = document.createElement('li');
        item.className = 'list-group-item px-0';
        const title = escapeHtml(action.action_label || action.action_type);
        const timestamp = escapeHtml(action.created_at || '');
        const user = escapeHtml(action.user || 'System');
        const description = escapeHtml(action.description || '');
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="fw-semibold">${title}</div>
                <div class="text-muted small ms-2">${timestamp}</div>
            </div>
            <div class="small text-muted">by ${user}</div>
            ${description ? `<div class="small mt-1">${description}</div>` : ''}
        `;
        actionHistoryList.appendChild(item);
    });
}

function refreshActionHistory() {
    return fetch(`/product-management/workflow/${stepId}/actions/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                actionHistory = data.actions || [];
                renderActionHistory();
            }
        })
        .catch(error => console.error('Failed to refresh action history:', error));
}

refreshActionsBtn?.addEventListener('click', function() {
    if (this.disabled) return;
    this.disabled = true;
    const original = this.innerHTML;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Refreshing';
    refreshActionHistory()
        .finally(() => {
            this.disabled = false;
            this.innerHTML = original;
        });
});

function renderDocumentList(selectedId = null) {
    if (!documentList) {
        return;
    }
    documentList.innerHTML = '';
    if (!Array.isArray(documentHistory) || documentHistory.length === 0) {
        if (documentEmptyState) documentEmptyState.style.display = 'block';
        if (documentPreview) documentPreview.style.display = 'none';
        if (documentMeta) documentMeta.style.display = 'none';
        if (documentPreviewEmpty) documentPreviewEmpty.style.display = 'block';
        return;
    }
    if (documentEmptyState) documentEmptyState.style.display = 'none';
    if (!selectedId) {
        activeDocumentId = documentHistory[0].id;
    } else {
        activeDocumentId = selectedId;
    }

    documentHistory.forEach(doc => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-start ${doc.id === activeDocumentId ? 'active' : ''}`;
        button.innerHTML = `
            <div>
                <div class="fw-semibold">${escapeHtml(doc.title)}</div>
                <div class="small">${escapeHtml(doc.document_label)} • ${escapeHtml(doc.created_at)}</div>
            </div>
            <i class="fas fa-chevron-right small opacity-50 ms-2"></i>
        `;
        button.addEventListener('click', () => {
            activeDocumentId = doc.id;
            renderDocumentList(activeDocumentId);
        });
        documentList.appendChild(button);
    });

    displayActiveDocument();
}

function displayActiveDocument() {
    if (!documentPreview || !documentMeta) {
        return;
    }
    const doc = documentHistory.find(d => d.id === activeDocumentId);
    if (!doc) {
        documentPreview.style.display = 'none';
        documentMeta.style.display = 'none';
        if (documentPreviewEmpty) documentPreviewEmpty.style.display = 'block';
        return;
    }
    if (documentPreviewEmpty) documentPreviewEmpty.style.display = 'none';
    documentPreview.innerHTML = marked.parse(doc.content || '');
    documentPreview.style.display = 'block';
    documentMeta.textContent = `Generated by ${doc.user} (${doc.source}) on ${doc.created_at}`;
    documentMeta.style.display = 'block';
}

function updateDocumentCount(count) {
    if (documentCountBadge) {
        documentCountBadge.textContent = count;
    }
}

function handleDocumentUpdate(document) {
    if (!document) {
        return;
    }
    documentHistory = documentHistory.filter(doc => doc.id !== document.id);
    documentHistory.unshift(document);
    updateDocumentCount(documentHistory.length);
    renderDocumentList(document.id);
}

editDescriptionBtn?.addEventListener('click', () => {
    toggleDescriptionEditor(true);
});

cancelDescriptionBtn?.addEventListener('click', () => {
    if (descriptionInput) {
        descriptionInput.value = descriptionCache;
    }
    toggleDescriptionEditor(false);
});

saveDescriptionBtn?.addEventListener('click', function() {
    if (!descriptionInput) {
        return;
    }

    const newDescription = descriptionInput.value;
    const originalLabel = this.innerHTML;
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

    fetch(`/product-management/workflow/${stepId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ description: newDescription })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            descriptionCache = data.description || '';
            renderDescriptionText(descriptionCache);
            if (descriptionInput) {
                descriptionInput.value = descriptionCache;
            }
            toggleDescriptionEditor(false);
            alert('Description updated successfully!');
            refreshActionHistory();
        } else {
            alert('Error: ' + (data.error || 'Unable to update description.'));
        }
    })
    .catch(error => {
        alert('Error updating description: ' + error);
    })
    .finally(() => {
        this.disabled = false;
        this.innerHTML = originalLabel;
    });
});

// Delete workflow step
document.querySelector('.delete-workflow-step-btn')?.addEventListener('click', function() {
    const stepId = this.getAttribute('data-step-id');
    const stepTitle = this.getAttribute('data-step-title');
    const stepType = this.getAttribute('data-step-type');

    if (confirm(`Are you sure you want to delete the ${stepType} "${stepTitle}"? This action cannot be undone.`)) {
        fetch(`/product-management/workflow/${stepId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = '/product-management/';
                }
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error deleting workflow step: ' + error);
        });
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
