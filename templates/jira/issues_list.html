{% extends "accounts/base.html" %}
{% block title %}My Jira Issues{% endblock %}
{% block content %}
<div class="jira-dashboard">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h4 mb-1 text-dark fw-semibold">My Jira Issues{% if cloud_name %} – {{ cloud_name }}{% endif %}</h1>
      <p class="text-muted mb-0">
        Tracking {{ total_issues }} assigned {{ total_issues|pluralize:"issue,issues" }}
        {% if latest_update %}• last update {{ latest_update|timesince }} ago{% endif %}
      </p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-dark btn-sm" href="{% url 'jira:connect' %}">
        <span class="me-2">Reconnect</span>
      </a>
      <a class="btn btn-brand btn-sm" href="{% url 'jira:issues' %}">
        <span class="me-2">Refresh</span>
      </a>
    </div>
  </div>

  {% if not issues %}
    <div class="card shadow-sm border-0">
      <div class="card-body text-center py-5">
        <h2 class="h5 text-brand mb-2">You're all caught up</h2>
        <p class="text-muted mb-4">No recent assigned issues found. Try refreshing or reconnecting to check for new work.</p>
        <a class="btn btn-brand btn-sm" href="{% url 'jira:connect' %}">Reconnect Atlassian</a>
      </div>
    </div>
  {% else %}
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-body">
        <div class="row gy-3 gx-4 align-items-center">
          <div class="col-12 col-lg-5">
            <label class="form-label fw-semibold small text-uppercase text-muted mb-1" for="issue-search">Quick search</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-transparent border-end-0 text-muted">Search</span>
              <input class="form-control border-start-0" id="issue-search" type="search" placeholder="Search by key, summary, or label" />
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <p class="form-label fw-semibold small text-uppercase text-muted mb-1 mb-lg-2">Status</p>
            <div class="btn-group btn-group-sm flex-wrap jira-status-filter" role="group">
              <button class="btn btn-outline-secondary active" type="button" data-status-filter="all">All ({{ total_issues }})</button>
              {% for status in status_summary %}
                <button class="btn btn-outline-secondary" type="button" data-status-filter="{{ status.slug }}">{{ status.name }} ({{ status.count }})</button>
              {% endfor %}
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <label class="form-label fw-semibold small text-uppercase text-muted mb-1" for="issue-type-filter">Issue type</label>
            <select class="form-select form-select-sm" id="issue-type-filter">
              <option value="all">All types</option>
              {% for item in type_summary %}
                <option value="{{ item.slug }}">{{ item.name }} ({{ item.count }})</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
    </div>

    <p class="text-muted small mb-3">Showing <span id="issue-visible-count">{{ total_issues }}</span> of {{ total_issues }} issues</p>

    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4" id="jira-issue-grid">
      {% for issue in issues %}
        <div class="col" data-issue-card data-status="{{ issue.status_slug }}" data-type="{{ issue.issue_type_slug }}" data-search="{{ issue.search_blob }}">
          <div class="card h-100 border-0 shadow-sm jira-issue-card">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start gap-2 mb-3">
                <div>
                  <span class="text-muted small">{{ issue.key }}</span>
                  <h2 class="h6 fw-semibold text-dark mb-0">{{ issue.summary|default:"No summary provided" }}</h2>
                </div>
                <span class="badge rounded-pill jira-status-chip jira-status--{{ issue.status_slug }}">{{ issue.status }}</span>
              </div>

              <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                <span class="badge rounded-pill text-bg-light jira-issue-type">{{ issue.issue_type }}</span>
                {% if issue.labels %}
                  {% for label in issue.labels %}
                    <span class="badge rounded-pill jira-label">{{ label }}</span>
                  {% endfor %}
                {% else %}
                  <span class="text-muted small">No labels</span>
                {% endif %}
              </div>

              <dl class="jira-meta small text-muted mb-4">
                <div>
                  <dt class="text-uppercase fw-semibold small mb-1">Assignee</dt>
                  <dd class="mb-0 text-dark">{{ issue.assignee }}</dd>
                </div>
                <div>
                  <dt class="text-uppercase fw-semibold small mb-1">Reporter</dt>
                  <dd class="mb-0 text-dark">{{ issue.reporter|default:"—" }}</dd>
                </div>
                <div>
                  <dt class="text-uppercase fw-semibold small mb-1">Updated</dt>
                  <dd class="mb-0 text-dark">
                    {% if issue.updated %}
                      {{ issue.updated|timesince }} ago
                    {% else %}
                      {{ issue.updated_raw|default:"Unknown" }}
                    {% endif %}
                  </dd>
                </div>
              </dl>

              {% if issue.development.branch or issue.development.commit or issue.development.pull_request %}
                <div class="jira-development mb-3">
                  <p class="text-uppercase fw-semibold small text-muted mb-1">Development</p>
                  <ul class="list-unstyled small mb-0 text-dark">
                    {% if issue.development.branch %}
                      <li><span class="text-muted">Branch</span>: {{ issue.development.branch }}</li>
                    {% endif %}
                    {% if issue.development.commit %}
                      <li><span class="text-muted">Commit</span>: {{ issue.development.commit }}</li>
                    {% endif %}
                    {% if issue.development.pull_request %}
                      <li><span class="text-muted">Pull request</span>: {{ issue.development.pull_request }}</li>
                    {% endif %}
                  </ul>
                </div>
              {% endif %}

              <div class="mt-auto d-flex gap-2">
                <a class="btn btn-outline-secondary btn-sm flex-grow-1" href="{% url 'jira:issue_edit' issue.key %}">View details</a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<script>
  (function () {
    const searchInput = document.getElementById('issue-search');
    const statusButtons = document.querySelectorAll('[data-status-filter]');
    const typeSelect = document.getElementById('issue-type-filter');
    const issueCards = document.querySelectorAll('[data-issue-card]');
    const counter = document.getElementById('issue-visible-count');

    let activeStatus = 'all';

    function updateCounter(count) {
      if (counter) {
        counter.textContent = count;
      }
    }

    function filterIssues() {
      const query = (searchInput?.value || '').trim().toLowerCase();
      const type = typeSelect ? typeSelect.value : 'all';
      let visible = 0;

      issueCards.forEach((card) => {
        const matchesStatus = activeStatus === 'all' || card.dataset.status === activeStatus;
        const matchesType = type === 'all' || card.dataset.type === type;
        const matchesQuery = !query || (card.dataset.search || '').includes(query);
        const isVisible = matchesStatus && matchesType && matchesQuery;

        card.classList.toggle('d-none', !isVisible);
        if (isVisible) {
          visible += 1;
        }
      });

      updateCounter(visible);
    }

    statusButtons.forEach((button) => {
      button.addEventListener('click', () => {
        activeStatus = button.dataset.statusFilter || 'all';
        statusButtons.forEach((btn) => btn.classList.remove('active'));
        button.classList.add('active');
        filterIssues();
      });
    });

    searchInput?.addEventListener('input', filterIssues);
    typeSelect?.addEventListener('change', filterIssues);

    filterIssues();
  })();
</script>
{% endblock %}
