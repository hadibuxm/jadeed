{% extends "accounts/base.html" %}
{% block title %}My Jira Issues{% endblock %}
{% block content %}
  <!-- Dashboard Header Section -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="h4 m-0 text-dark font-weight-bold">My Jira Issues{% if cloud_name %} – {{ cloud_name }}{% endif %}</h1>
    <a class="btn btn-outline-dark btn-sm" href="{% url 'jira:connect' %}">
      <i class="fas fa-sync-alt"></i> Reconnect
    </a>
  </div>

  <!-- Empty State Section -->
  {% if not issues %}
    <div class="alert alert-info d-flex align-items-center">
      <i class="fas fa-exclamation-circle mr-2"></i>
      <span>No recent assigned issues found.</span>
    </div>
  {% else %}
    <!-- Issues List Section -->
    <div class="row">
      {% for i in issues %}
        <div class="col-md-4 mb-4">
          <div class="card shadow-sm border-light h-100">
            <div class="card-body d-flex flex-column">
              <!-- Issue Header with Dynamic Title Color -->
              <div class="issue-header d-flex justify-content-between align-items-start mb-3">
                <h6 class="card-title issue-title 
                  {% if i.fields.status.name == 'To Do' %}text-primary
                  {% elif i.fields.status.name == 'In Progress' %}text-warning
                  {% else %}text-success{% endif %} mb-0">
                  {{ i.key }} — {{ i.fields.summary }}
                </h6>
                
                <!-- Issue Type Label with Badge -->
              <small class=" 
                {% if i.fields.issuetype.name == 'Story' %}badge-info
                {% elif i.fields.issuetype.name == 'Task' %}badge-primary
                {% elif i.fields.issuetype.name == 'Bug' %}badge-danger
                {% else %}badge-secondary{% endif %}">
                <b>{{ i.fields.issuetype.name }}</b>
              </small>
              </div>

              <!-- Updated Timestamp -->
              <p class="text-muted small mb-3">
                <i class="fas fa-clock"></i> Updated: {{ i.fields.updated }}
              </p>

              <!-- Status Section with Dynamic Badge -->
              <div class="d-flex align-items-center mb-3">
                <small>
                  <b>Status: </b>{{ i.fields.status.name }}
                </small>
              </div>

              <!-- Assignee Section -->
              <div class="d-flex align-items-center mb-3">
                <small>
                  <b>Assignee: </b>{{ i.fields.assignee.displayName }}
                </small>
              </div>

              <!-- Labels Section -->
              <div class="d-flex align-items-center mb-3">
                <small>
                  <b>Labels: </b>
                  {% if i.fields.labels %}
                    {{ i.fields.labels|join:', ' }}
                  {% else %}
                    No labels
                  {% endif %}
                </small>
              </div>

              <!-- Reporter Section -->
              <div class="d-flex align-items-center mb-3">
                <small>
                  <b>Reporter: </b>{{ i.fields.reporter.displayName }}
                </small>
              </div>

              <!-- Development Section -->
              {% if i.fields.development %}
                <div class="d-flex align-items-center mb-3">
                  <small>
                    <b>Development: </b>
                    {% if i.fields.development.branch %}
                      <span>Branch: {{ i.fields.development.branch }}</span>
                    {% endif %}
                    {% if i.fields.development.commit %}
                      <span class="ml-3">Commit: {{ i.fields.development.commit }}</span>
                    {% endif %}
                    {% if i.fields.development.pullRequest %}
                      <span class="ml-3">Pull Request: {{ i.fields.development.pullRequest }}</span>
                    {% endif %}
                  </small>
                </div>
              {% else %}
                <div class="d-flex align-items-center mb-3">
                  <small>
                    <b>Development: </b> No development details available.
                  </small>
                </div>
              {% endif %}

              <!-- Spacer to ensure alignment of button -->
              <div class="mt-auto"></div>

              <!-- View Details Link -->
              <a href="{% url 'jira:issue_edit' i.key %}" class="btn btn-outline-secondary btn-sm w-100">
                <i class="fas fa-eye"></i> View Details
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}

{% block extra_css %}
  <style>
    /* Custom Colors for Status */
    .status-open {
      background-color: #007bff; /* Blue for Open */
      color: white;
    }
    .status-in-progress {
      background-color: #ffc107; /* Yellow for In Progress */
      color: black;
    }
    .status-closed {
      background-color: #28a745; /* Green for Closed */
      color: white;
    }

    /* Issue Type Styling with Rounded Badges */
    .badge-info {
      background-color: #17a2b8;
      color: white;
    }
    .badge-primary {
      background-color: #007bff;
      color: white;
    }
    .badge-danger {
      background-color: #dc3545;
      color: white;
    }
    .badge-secondary {
      background-color: #6c757d;
      color: white;
    }

    .issue-header {
      flex-wrap: wrap;
      gap: 0.5rem;
      position: relative;
      z-index: 5;
    }

    .issue-title {
      flex: 1 1 auto;
      min-width: 0;
      word-break: break-word;
    }

    .issue-type-badge {
      flex-shrink: 0;
      white-space: nowrap;
      position: relative;
      z-index: 10;
    }

    /* Ensure card height remains consistent */
    .card {
      overflow: visible;
    }
    
    .card-body {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      overflow: visible;
    }
  </style>
{% endblock %}